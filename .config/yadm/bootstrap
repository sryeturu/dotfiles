#!/bin/bash

echo "--- Updating System Databases ---"
sudo pacman -Syu --noconfirm

if ! command -v paru &> /dev/null; then
    echo "--- Paru not found. Building from source... ---"
    
    sudo pacman -S --needed base-devel git --noconfirm
    
    # Create a clean temporary build space
    temp_dir=$(mktemp -d)
    git clone https://aur.archlinux.org/paru.git "$temp_dir"
    
    cd "$temp_dir" && makepkg -si --noconfirm
    
    # Clean up
    cd - && rm -rf "$temp_dir"
else
    echo "--- Paru is already installed. Checking for library health... ---"
    if ! paru -V &>/dev/null; then
        echo "--- Paru is broken (Library mismatch). Rebuilding... ---"
        temp_dir=$(mktemp -d)
        git clone https://aur.archlinux.org/paru.git "$temp_dir"
        cd "$temp_dir" && makepkg -si --noconfirm
        cd - && rm -rf "$temp_dir"
    fi
fi

# --- PACKAGE LIST ---
PACKAGES=(
    alsa-utils
    anki-bin
    beautyline
    calibre
    conky
    cronie
    discord
    dunst
    dust
    efibootmgr
    feh
    font-manager
    ghostty
    google-chrome
    grub
    i3-wm
    i3lock
    light
    lxappearance
    man-pages
    nano
    networkmanager
    noto-fonts
    noto-fonts-emoji
    papirus-icon-theme
    pavucontrol
    picom
    polybar
    redshift
    reflector
    rofi
    sudo
    tlp
    ttf-hack
    ttf-icomoon-feather
    ttf-roboto
    udiskie
    uv
    visual-studio-code-bin
    woff2-font-awesome
    wp-cli
    xclip
    xdotool
    xorg-server
    xorg-xinit
    xorg-xrandr
    yadm
    zip
)

echo "--- Installing Packages from List ---"
paru -S --needed --noconfirm "${PACKAGES[@]}"

echo "--- Enabling Services ---"
sudo systemctl enable --now NetworkManager
sudo systemctl enable --now tlp
sudo systemctl enable --now cronie

echo "--- [ SUCCESS ] Bootstrap Complete! ---"
